<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>FIN-JOD · บันทึก + หนี้ + รายการย้อนหลัง (หน้าเดียวจบ • Fast)</title>

  <!-- Performance: preconnect เพื่อให้ฟอนต์มาไวขึ้น + display=swap ไม่บล็อกการวาด -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600&display=swap" rel="stylesheet">

  <!-- Performance: DNS/connection warmup สำหรับ LIFF + Apps Script -->
  <link rel="dns-prefetch" href="https://static.line-scdn.net">
  <link rel="preconnect" href="https://static.line-scdn.net" crossorigin>
  <link rel="dns-prefetch" href="https://script.google.com">
  <link rel="preconnect" href="https://script.google.com" crossorigin>

  <style>
    :root{
      --bg:#1e1e1e; --panel:#242424; --line:#3a3a3a; --muted:#bfbfbf; --text:#f1f1f1;
      --primary:#00c896; --danger:#ff4d4f; --blue:#6c8cff; --warn:#ffb020; --cyan:#2dd4bf;
    }
    *{ box-sizing:border-box } html,body{ height:100% }
    body{
      margin:0; padding:clamp(.75rem,2vw,1.25rem);
      padding-bottom:calc(clamp(.75rem,2vw,1.25rem) + env(safe-area-inset-bottom,0px));
      font-family:'Kanit', system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
      background:var(--bg); color:var(--text)
    }
    .wrap{ width:min(1140px,100%); margin:auto; background:var(--panel); border:1px solid var(--line);
      border-radius:20px; padding:clamp(1rem,2.2vw,1.5rem) }
    h1{ margin:.25rem 0 1rem; font-size:clamp(1.25rem,4.5vw,1.8rem); color:var(--primary); text-align:center }
    .head{ display:flex; align-items:center; gap:.75rem; margin-bottom:.75rem }
    .head .you{ margin-left:auto; color:#9fe9d4; font-weight:600 }
    .card{ background:#1f1f1f; border:1px solid var(--line); border-radius:16px; padding:1rem; margin-bottom:1rem }
    .row{ display:flex; gap:1rem; flex-wrap:wrap; margin-bottom:1rem }
    .col{ flex:1 1 46%; min-width:230px; display:flex; flex-direction:column; gap:.35rem }
    label{ color:var(--muted) }
    input,select,button{ border-radius:12px; border:1px solid var(--line); background:#1d1d1d; color:#fff; min-height:44px; padding:.9rem 1rem; font-size:16px }
    input[type=number]{ text-align:right; -moz-appearance:textfield }
    input[type=number]::-webkit-outer-spin-button,input[type=number]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0 }
    button{ background:var(--primary); border:none; font-weight:700; cursor:pointer }
    button:disabled{ opacity:.6; cursor:not-allowed }
    .btn-ghost{ background:#333 } .btn-blue{ background:var(--blue) } .btn-warn{ background:var(--warn); color:#222 } .btn-danger{ background:var(--danger) } .btn-cyan{ background:var(--cyan); color:#052a27 } .btn-green{ background:var(--primary) }

    .chips{ display:flex; gap:.5rem; flex-wrap:wrap }
    .chip{ padding:.5rem .8rem; border-radius:999px; background:#2a2a2a; border:1px solid var(--line); cursor:pointer; user-select:none }
    .chip.active{ background:var(--blue) }

    .seg{ display:flex; gap:.5rem; flex-wrap:wrap }
    .seg button{ background:#333 }
    .seg button.active{ background:var(--primary); color:#052a27 }

    .muted{ color:var(--muted) }
    .right{ text-align:right }

    table{ width:100%; border-collapse:collapse; table-layout:fixed; font-size:.98rem }
    th,td{ border-bottom:1px solid var(--line); padding:.8rem .5rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; vertical-align:middle }
    th{ color:var(--muted); font-weight:600; text-align:left; position:sticky; top:0; background:#1f1f1f; z-index:1 }
    .table-viewport{ max-height:72vh; overflow:auto; border-radius:12px; border:1px solid var(--line) }
    .table-viewport tbody tr:hover{ background:#2a2a2a }
    td:last-child{ overflow:visible }
    td:last-child .actions{ display:flex; gap:.5rem; flex-wrap:wrap }

    .badge{ padding:.25rem .5rem; border-radius:999px; font-size:.85rem }
    .badge-inc{ background:rgba(0,200,150,.18); color:#9ff3df; border:1px solid rgba(0,200,150,.35) }
    .badge-exp{ background:rgba(233,30,99,.15); color:#ffb6cc; border:1px solid rgba(233,30,99,.35) }
    .badge-sav{ background:rgba(45,212,191,.16); color:#a7fff0; border:1px solid rgba(45,212,191,.35) }
    .badge-debt{ background:rgba(108,140,255,.16); color:#c8d2ff; border:1px solid rgba(108,140,255,.35) }

    #toast{ position:fixed; left:50%; bottom:calc(18px + env(safe-area-inset-bottom,0px)); transform:translateX(-50%);
      background:#333; color:#fff; padding:.6rem .9rem; border-radius:10px; opacity:0; transition:opacity .25s; pointer-events:none; z-index:120 }
    #overlay{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.25); z-index:110; transition:opacity .2s }
    #overlay.hide{ opacity:0; pointer-events:none }
    .spinner{ width:42px; height:42px; border-radius:50%; border:5px solid #3a3a3a; border-top-color:#fff; animation:spin 1s linear infinite }
    @keyframes spin{ to{ transform:rotate(360deg) } }

    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:150 }
    .modal-backdrop.show{ display:flex }
    .modal{ width:min(640px,96vw); background:#242424; border:1px solid var(--line); border-radius:16px; padding:1rem 1rem 1.25rem }
    .modal .title{ font-weight:700; margin-bottom:.75rem }
    .modal .actions{ display:flex; gap:.5rem; justify-content:flex-end; margin-top:.75rem }

    .help{ font-size:.9rem; color:var(--muted) }
    .hide{ display:none }
  </style>

  <!-- LIFF SDK (ไม่บล็อกการวาด) -->
  <script defer src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="head">
      <h1 style="margin:0">FIN-JOD · หน้าเดียวครบ (Fast)</h1>
      <div class="you" id="who"></div>
    </div>

    <!-- ===== บันทึกทั่วไป + หนี้ ===== -->
    <div class="card" role="region" aria-label="บันทึกธุรกรรม">
      <div class="row">
        <div class="col">
          <label for="txDate">วันที่</label>
          <input id="txDate" type="date" />
        </div>
        <div class="col">
          <label>ประเภท</label>
          <div class="seg">
            <button class="segbtn" data-type="expense">รายจ่าย</button>
            <button class="segbtn" data-type="income">รายรับ</button>
            <button class="segbtn" data-type="saving">ออมเงิน</button>
            <span class="muted" style="align-self:center">|</span>
            <button class="segbtn" data-type="debt_repay" title="จ่ายหนี้">จ่ายหนี้</button>
            <button class="segbtn" data-type="debt_borrow" title="กู้หนี้">กู้หนี้</button>
          </div>
          <select id="txType" class="hide" aria-hidden="true">
            <option value="expense" selected>รายจ่าย</option>
            <option value="income">รายรับ</option>
            <option value="saving">ออมเงิน</option>
            <option value="debt_repay">จ่ายหนี้</option>
            <option value="debt_borrow">กู้หนี้</option>
          </select>
        </div>

        <div class="col" id="colCat">
          <label for="txCat">หมวดหมู่</label>
          <select id="txCat"></select>
          <div class="help">* เพิ่มหมวดในหน้าหลักของคุณได้ตามเดิม</div>
        </div>
        <div class="col" id="colAmount">
          <label for="txAmount">จำนวนเงิน (บาท)</label>
          <input id="txAmount" type="number" step="0.01" inputmode="decimal" placeholder="0.00" />
        </div>

        <!-- หนี้ -->
        <div class="col hide" id="colDebt">
          <label for="txDebt">เลือกเจ้าหนี้</label>
          <div class="row" style="margin:0; gap:.5rem">
            <div class="col" style="min-width:200px"><select id="txDebt"></select></div>
            <div class="col" style="flex:0 0 auto">
              <button id="btnAddDebtOpen" class="btn-blue">+ เพิ่มเจ้าหนี้</button>
            </div>
          </div>
          <div class="help">* รายการนี้ดึงจากรายชื่อเจ้าหนี้ด้านล่าง</div>
        </div>
        <div class="col hide" id="colDebtRepayFields" style="flex:1 1 100%">
          <label>รายละเอียดการจ่ายหนี้</label>
          <div class="row" style="gap:.5rem; margin:0">
            <div class="col"><input id="txInt" type="number" step="0.01" placeholder="จ่ายดอก (บาท)" /></div>
            <div class="col"><input id="txPrin" type="number" step="0.01" placeholder="จ่ายต้น (บาท)" /></div>
          </div>
          <div class="help">* ระบบจะบันทึกยอดรวม = จ่ายดอก + จ่ายต้น</div>
        </div>
      </div>

      <div class="row" style="align-items:flex-end; gap:1rem">
        <div class="col" style="flex:1 1 0">
          <label for="txNote">หมายเหตุ</label>
          <input id="txNote" placeholder="รายละเอียดเพิ่มเติม (ถ้ามี)" maxlength="500" />
        </div>
        <div class="col" style="flex:0 0 auto">
          <button id="btnSave" class="btn-green" style="min-width:180px">บันทึกรายการ</button>
        </div>
      </div>
    </div>

    <!-- ===== จัดการเจ้าหนี้แบบย่อ ===== -->
    <div class="card" role="region" aria-label="จัดการเจ้าหนี้">
      <div class="muted" style="margin-bottom:.35rem">เพิ่ม/แก้ไข/ปิดบัญชี เจ้าหนี้ (ย่อ)</div>
      <div class="row" id="debtAddRow" style="margin-bottom:.75rem">
        <div class="col"><label for="dName">ชื่อเจ้าหนี้</label><input id="dName" placeholder="เช่น บัตร X / เพื่อน A" /></div>
        <div class="col"><label for="dRate">อัตราดอกเบี้ยต่อปี (%)</label><input id="dRate" type="number" step="0.01" placeholder="เช่น 18" /></div>
        <div class="col"><label for="dPrincipal">ยอดตั้งต้น (ไม่บังคับ)</label><input id="dPrincipal" type="number" step="0.01" placeholder="เช่น 10000" /></div>
        <div class="col" style="align-self:flex-end"><button id="btnAddDebt" class="btn-blue">+ เพิ่มเจ้าหนี้</button></div>
      </div>
      <div class="table-viewport">
        <table>
          <thead>
            <tr>
              <th style="width:240px">เจ้าหนี้</th>
              <th class="right" style="width:110px">% ต่อปี</th>
              <th class="right" style="width:140px">เงินต้น</th>
              <th class="right" style="width:140px">ดอกค้าง</th>
              <th class="right" style="width:150px">รวมที่ต้องจ่าย</th>
              <th style="width:120px">อัปเดตถึง</th>
              <th style="width:220px">จัดการ</th>
            </tr>
          </thead>
          <tbody id="tblDebts"></tbody>
        </table>
      </div>
    </div>

    <!-- ===== รายการย้อนหลัง ===== -->
    <div class="card" role="region" aria-label="รายการย้อนหลัง">
      <div class="row">
        <div class="col"><label for="fFrom">จาก</label><input id="fFrom" type="date" /></div>
        <div class="col"><label for="fTo">ถึง</label><input id="fTo" type="date" /></div>
        <div class="col">
          <label>&nbsp;</label>
          <div class="chips">
            <div class="chip" data-range="today">วันนี้</div>
            <div class="chip" data-range="7">7 วัน</div>
            <div class="chip" data-range="30">30 วัน</div>
            <div class="chip" data-range="month">เดือนนี้</div>
            <div class="chip" data-range="year">ปีนี้</div>
            <button id="btnRefresh" class="btn-blue" style="margin-left:auto">รีเฟรช</button>
          </div>
          <div class="muted" style="margin-top:.4rem">กำลังดู: <b id="rangeBadge">กำหนดเอง</b></div>
        </div>
      </div>

      <div class="table-viewport">
        <table>
          <thead>
            <tr>
              <th style="width:110px">วันที่</th>
              <th style="width:140px">ประเภท</th>
              <th>หมวด/เจ้าหนี้</th>
              <th class="right" style="width:130px">จำนวน</th>
              <th>หมายเหตุ</th>
              <th style="width:160px">จัดการ</th>
            </tr>
          </thead>
          <tbody id="tblBody"></tbody>
        </table>
      </div>
      <div id="emptyList" class="muted" style="margin-top:.5rem; display:none">ยังไม่มีรายการ</div>
    </div>
  </div>

  <!-- ===== Modals ===== -->
  <div id="editBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="editTitle">
      <div id="editTitle" class="title">แก้ไขรายการ</div>
      <input id="editTxId" type="hidden">

      <div class="row">
        <div class="col"><label for="editDate">วันที่</label><input id="editDate" type="date"></div>

        <div class="col" id="editColType">
          <label for="editType">ประเภท</label>
          <select id="editType">
            <option value="expense">รายจ่าย</option>
            <option value="income">รายรับ</option>
            <option value="saving">ออมเงิน</option>
          </select>
        </div>

        <div class="col" id="editColCat"><label for="editCat">หมวดหมู่</label><select id="editCat"></select></div>

        <div class="col" id="editColAmount">
          <label for="editAmount">จำนวนเงิน (บาท)</label>
          <input id="editAmount" type="number" step="0.01" placeholder="0.00">
        </div>

        <div class="col hide" id="editColDebtRepayFields" style="flex:1 1 100%">
          <label>รายละเอียดการจ่ายหนี้</label>
          <div class="row" style="gap:.5rem; margin:0">
            <div class="col"><input id="editInt" type="number" step="0.01" placeholder="จ่ายดอก (บาท)"></div>
            <div class="col"><input id="editPrin" type="number" step="0.01" placeholder="จ่ายต้น (บาท)"></div>
          </div>
          <div class="help">* ยอดรวม = จ่ายดอก + จ่ายต้น (อัปเดตรวมให้อัตโนมัติ)</div>
        </div>

        <div class="col" style="flex:1 1 100%"><label for="editNote">หมายเหตุ</label><input id="editNote" maxlength="500" placeholder="รายละเอียดเพิ่มเติม (ถ้ามี)"></div>
      </div>

      <div class="actions">
        <button id="btnDelete" class="btn-danger">ลบ</button>
        <button id="btnCancel" class="btn-ghost">ยกเลิก</button>
        <button id="btnUpdate" class="btn-warn">บันทึกการแก้ไข</button>
      </div>
    </div>
  </div>

  <div id="editDebtBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="editDebtTitle">
      <div id="editDebtTitle" class="title">แก้ไขเจ้าหนี้</div>
      <input id="editDebtId" type="hidden">
      <div class="row">
        <div class="col"><label for="editDebtName">ชื่อเจ้าหนี้</label><input id="editDebtName" placeholder="เช่น บัตร X / เพื่อน A"></div>
        <div class="col"><label for="editDebtRate">อัตราดอกต่อปี (%)</label><input id="editDebtRate" type="number" step="0.01"></div>
      </div>
      <div class="actions">
        <button id="btnEditDebtCancel" class="btn-ghost">ยกเลิก</button>
        <button id="btnEditDebtSave" class="btn-green">บันทึก</button>
      </div>
    </div>
  </div>

  <div id="toast">แจ้งเตือน</div>
  <div id="overlay" class="hide" aria-live="polite" aria-busy="true"><div class="spinner"></div></div>

  <script>
/** ====== CONFIG ====== */
const LIFF_ID = '2008276151-ER9Bz3Pz'; // ใส่ LIFF ID ของคุณ
const API_URL = 'https://script.google.com/macros/s/AKfycbxV3xOU1kQM86jUJtfer8hW_HgYkcLfpH942saPVbCZ1RDmN_4LYjpk72OxdKKLQAFt/exec'; // GAS WebApp

/** ====== STATE ====== */
let token = localStorage.getItem('fin_token') || '';
let displayName = localStorage.getItem('fin_name') || '';
let lastItems = [];
let cats = { income:[], expense:[], saving:[] };
let debtsCache = [];
const THB = new Intl.NumberFormat('th-TH',{minimumFractionDigits:2, maximumFractionDigits:2});

/** ====== HELPERS ====== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const fmt = n => THB.format(Number(n||0));
const esc = s => String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const toast = (msg, ok=true)=>{ const el=$('#toast'); el.textContent=msg; el.style.background= ok?'#00c896':'#ff4d4f'; el.style.opacity='1'; setTimeout(()=> el.style.opacity='0', 2200); };
const showOverlay = (on)=> $('#overlay').classList.toggle('hide', !on);
const toYMD = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
const todayISO = ()=> toYMD(new Date());
const monthBounds = d => ({ start: toYMD(new Date(d.getFullYear(), d.getMonth(), 1)), end: toYMD(new Date(d.getFullYear(), d.getMonth()+1, 0)) });
const safeKey = x => `${(x.date||'').slice(0,10)}T${(x.time||'00:00:00').slice(0,8)}`;
const debounce = (fn,ms=300)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };

/** ====== API WRAPPER ====== */
async function fetchJSON(url, options={}){
  try{
    const res = await fetch(url, { ...options, headers:{'Content-Type':'text/plain;charset=utf-8', ...(options.headers||{})} });
    const text = await res.text();
    try { return JSON.parse(text); } catch{ return { ok:false, error:'NON_JSON', raw:text }; }
  }catch(e){ return { ok:false, error:'NETWORK', message:String(e&&e.message||e) }; }
}
async function api(path, payload={}, useToken=true, overlay=false){
  const body = { path, payload }; if (useToken && token) body.token = token;
  if (overlay) showOverlay(true);
  try{ return await fetchJSON(API_URL, { method:'POST', body: JSON.stringify(body) }); }
  finally{ if (overlay) showOverlay(false); }
}

/** ====== LIFF auto login (ไม่บล็อก UI) ====== */
async function ensureTokenViaLIFF(){
  try{
    await liff.init({ liffId: LIFF_ID });
  }catch{ toast('เริ่ม LIFF ไม่สำเร็จ', false); return false; }
  if (!liff.isLoggedIn()){ liff.login({ redirectUri: location.href }); return false; }

  let prof; try{ prof = await liff.getProfile(); }catch{ toast('อ่านโปรไฟล์ LINE ไม่ได้', false); return false; }
  const r = await api('liff/link_or_login', { line_user_id: prof.userId, display_name: prof.displayName||'' }, false);
  if (!r.ok){ toast(r.message || 'เกิดข้อผิดพลาด', false); return false; }
  if (r.need_verification){
    $('#who').textContent = prof.displayName || '';
    toast('ยังไม่ผูกบัญชี กรุณาไปผูกก่อน', false);
    return false;
  }
  token = r.token; displayName = r.display_name || prof.displayName || '';
  localStorage.setItem('fin_token', token);
  localStorage.setItem('fin_name', displayName);
  $('#who').textContent = displayName;
  return true;
}

/** ====== Categories (โหลดพร้อมกัน) ====== */
async function loadCategoriesAll(){
  const types = ['income','expense','saving'];
  const results = await Promise.all(types.map(t=> api('categories/list', { type:t }, true)));
  types.forEach((t,i)=>{ cats[t] = results[i].ok ? (results[i].items||[]) : []; });
}
function fillSelect(el, items, getVal, getText){
  const frag = document.createDocumentFragment();
  for(const it of items){
    const o=document.createElement('option');
    o.value=getVal(it); o.textContent=getText(it); frag.appendChild(o);
  }
  el.innerHTML=''; el.appendChild(frag);
}
function populateCatSelect(){
  const t = $('#txType').value;
  fillSelect($('#txCat'), (cats[t]||[]), c=>c.category_id, c=>c.name_th||c.category_id);
}
function populateEditCatSelect(){
  const t = $('#editType').value;
  fillSelect($('#editCat'), (cats[t]||[]), c=>c.category_id, c=>c.name_th||c.category_id);
}

/** ====== Debts (โหลด + สรุป แบบขนาน) ====== */
async function loadDebtsBoth(){
  const [rList, rSum] = await Promise.all([ api('debts/list', {}, true), api('debts/summary', {}, true) ]);
  debtsCache = rList.ok ? (rList.items||[]) : [];
  const mapById = Object.fromEntries((debtsCache||[]).map(d=> [d.debt_id, d]));
  const rows = (rSum.ok ? (rSum.items||[]) : []).map(x=>{
    const d = mapById[x.debt_id] || {};
    const principal = Number(x.principal_current ?? d.principal_current ?? 0);
    const accrued   = Number(x.accrued_interest  ?? d.accrued_interest  ?? 0);
    const rate      = Number(x.annual_rate       ?? d.annual_rate       ?? 0);
    const total_due = (typeof x.total_due === 'number' && Number.isFinite(x.total_due))
      ? x.total_due
      : principal + accrued;
    return {
      debt_id: x.debt_id,
      lender_name: x.lender_name || d.lender_name || '',
      rate, principal, accrued, total: total_due,
      last_calc_date: d.last_calc_date || x.as_of || ''
    };
  });
  // fill pickers
  fillSelect($('#txDebt'), debtsCache, d=>d.debt_id, d=>d.lender_name||d.debt_id);
  // render table (batch)
  const tb = $('#tblDebts'); tb.innerHTML='';
  if (!rows.length){ tb.innerHTML = '<tr><td colspan="7" class="muted" style="text-align:center">ยังไม่มีหนี้ที่เปิดอยู่</td></tr>'; return; }
  const frag = document.createDocumentFragment();
  for (const r of rows){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${esc(r.lender_name)}</td>
      <td class="right">${fmt(r.rate)}</td>
      <td class="right">${fmt(r.principal)}</td>
      <td class="right">${fmt(r.accrued)}</td>
      <td class="right"><b>${fmt(r.total)}</b></td>
      <td>${esc((r.last_calc_date||'').slice(0,10))}</td>
      <td>
        <div class="actions">
          <button class="btn-ghost" data-dact="edit"  data-id="${esc(r.debt_id)}">แก้ไข</button>
          <button class="btn-danger" data-dact="close" data-id="${esc(r.debt_id)}">ปิดบัญชี</button>
        </div>
      </td>`;
    frag.appendChild(tr);
  }
  tb.appendChild(frag);
}

/** ====== Type Switch ====== */
function setType(type){
  $('#txType').value = type;
  $$('.segbtn').forEach(b=> b.classList.toggle('active', b.dataset.type===type));
  const debtMode = (type==='debt_repay' || type==='debt_borrow');
  const isRepay = (type==='debt_repay');
  $('#colCat').classList.toggle('hide', debtMode);
  $('#colAmount').classList.toggle('hide', isRepay && debtMode);
  $('#colDebt').classList.toggle('hide', !debtMode);
  $('#colDebtRepayFields').classList.toggle('hide', !isRepay);
  if (!debtMode) populateCatSelect();
}

/** ====== Save Transaction ====== */
function normalizeAmount(v){ const n=Number(v); return (isFinite(n) && n>0) ? Math.round(n*100)/100 : NaN; }
function clearForm(){
  $('#txDate').value = todayISO();
  $('#txAmount').value=''; $('#txNote').value='';
  $('#txInt').value=''; $('#txPrin').value='';
  if ($('#txCat').options.length) $('#txCat').selectedIndex = 0;
  if ($('#txDebt').options.length) $('#txDebt').selectedIndex = 0;
}
async function saveTx(){
  const type = $('#txType').value;
  const date = $('#txDate').value;
  const note = $('#txNote').value.trim();
  if (!date){ toast('กรุณาเลือกวันที่', false); return; }
  $('#btnSave').disabled = true;

  if (type==='debt_repay' || type==='debt_borrow'){
    const debt_id = $('#txDebt').value;
    if (!debt_id){ toast('กรุณาเลือกเจ้าหนี้', false); $('#btnSave').disabled=false; return; }

    if (type==='debt_repay'){
      const interest = Number($('#txInt').value||0);
      const principal = Number($('#txPrin').value||0);
      const amount = Math.round((interest + principal) * 100)/100;
      if (!(isFinite(amount) && amount>0)){ toast('ใส่ยอดจ่ายดอก/จ่ายต้นให้ถูกต้อง', false); $('#btnSave').disabled=false; return; }
      const r = await api('debts/repay', { debt_id, date, amount, interest_paid:interest, principal_paid:principal, note }, true, true);
      $('#btnSave').disabled = false;
      if (r.ok){ toast('บันทึกจ่ายหนี้สำเร็จ'); clearForm(); loadDebtsBoth(); refreshList(); $('#txAmount').focus(); }
      else toast(r.message||'บันทึกไม่สำเร็จ', false);
      return;
    }else{
      const amount = normalizeAmount($('#txAmount').value);
      if (isNaN(amount)){ toast('จำนวนเงินไม่ถูกต้อง', false); $('#btnSave').disabled=false; return; }
      const r = await api('debts/borrow', { debt_id, date, amount, note }, true, true);
      $('#btnSave').disabled = false;
      if (r.ok){ toast('บันทึกกู้หนี้สำเร็จ'); clearForm(); loadDebtsBoth(); refreshList(); $('#txAmount').focus(); }
      else toast(r.message||'บันทึกไม่สำเร็จ', false);
      return;
    }
  }

  const amount = normalizeAmount($('#txAmount').value);
  const category_id = $('#txCat').value;
  if (isNaN(amount)){ toast('จำนวนเงินไม่ถูกต้อง', false); $('#btnSave').disabled=false; return; }
  if (!category_id){ toast('กรุณาเลือกหมวด', false); $('#btnSave').disabled=false; return; }

  const payload = { date, type, category_id, amount, note };
  const r = await api('transactions/create', payload, true, true);
  $('#btnSave').disabled = false;
  if (r.ok){ toast('บันทึกสำเร็จ'); clearForm(); refreshList(); $('#txAmount').focus(); }
  else toast('บันทึกไม่สำเร็จ', false);
}
$('#btnSave').addEventListener('click', saveTx);

/** ====== List + Edit/Delete (เรนเดอร์แบบ batch) ====== */
function renderTable(items){
  const tb = $('#tblBody'); tb.innerHTML='';
  const sorted = items.slice().sort((a,b)=> safeKey(b).localeCompare(safeKey(a)));
  $('#emptyList').style.display = sorted.length? 'none':'block';

  const catMap = {};
  [...(cats.expense||[]), ...(cats.income||[]), ...(cats.saving||[])]
    .forEach(c=> catMap[c.category_id]=c.name_th);

  const frag = document.createDocumentFragment();
  for (const x of sorted){
    const isDebtTx = (x.debt_tx_id || x.type==='debt' || (x.category_name||'').includes('หนี้'));
    const isRepay = isDebtTx && (String(x.sub_type||'repay').includes('repay') || (x.note||'').includes('จ่ายหนี้'));
    const badge = isDebtTx ? 'badge-debt' : (x.type==='income' ? 'badge-inc' : (x.type==='saving'?'badge-sav':'badge-exp'));
    const typeTxt = isDebtTx ? (isRepay?'จ่ายหนี้':'กู้หนี้') : (x.type==='income'?'รายรับ':(x.type==='saving'?'ออมเงิน':'รายจ่าย'));
    const catName = isDebtTx ? (x.lender_name || x.category_name || 'เจ้าหนี้') : (catMap[x.category_id] || x.category_name || x.category_id || '');

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td title="${esc((x.date||'').slice(0,10))}">${esc((x.date||'').slice(0,10))}</td>
      <td><span class="badge ${badge}">${typeTxt}</span></td>
      <td>${esc(catName)}</td>
      <td class="right">${fmt(+x.amount||0)}</td>
      <td>${esc(x.note||'')}</td>
      <td>
        <div class="actions">
          <button class="btn-ghost" data-act="edit" data-id="${esc(x.tx_id||'')}">แก้ไข</button>
          <button class="btn-danger" data-act="del"  data-id="${esc(x.tx_id||'')}">ลบ</button>
        </div>
      </td>`;
    frag.appendChild(tr);
  }
  tb.appendChild(frag);
}
async function refreshList(){
  if (!token){ toast('ยังไม่ได้รับสิทธิ์เข้าใช้งาน', false); return; }
  const from=$('#fFrom').value, to=$('#fTo').value;
  showOverlay(true);
  const r = await api('transactions/list', { from, to, type:'all' }, true);
  showOverlay(false);
  if (!r.ok){ toast('โหลดรายการไม่สำเร็จ', false); return; }
  lastItems = (r.items||[]).map(x=> ({...x, amount:+x.amount}));
  renderTable(lastItems);
}
$('#tblBody').addEventListener('click', (e)=>{
  const btn = e.target.closest('button[data-act]');
  if (!btn) return;
  const id = btn.getAttribute('data-id');
  const act = btn.getAttribute('data-act');
  if (act==='edit') openEditById(id);
  if (act==='del')  confirmDelete(id);
});

async function openEditById(txId){
  if (!txId){ toast('ไม่พบรหัสรายการ', false); return; }
  let it = lastItems.find(x=> String(x.tx_id)===String(txId));
  if (!it){
    const r = await api('transactions/list', { from: $('#fFrom').value, to: $('#fTo').value, type:'all' }, true);
    if (!r.ok){ toast('โหลดรายการไม่สำเร็จ', false); return; }
    lastItems = (r.items||[]); it = lastItems.find(x=> String(x.tx_id)===String(txId));
    if (!it){ toast('รายการหายไปแล้ว', false); return; }
  }
  const isDebtRepay = !!it.debt_tx_id && (String(it.debt_type||'repay').includes('repay') || (it.category_name||'').includes('จ่ายหนี้'));
  $('#editTxId').value = it.tx_id;
  $('#editDate').value = (it.date||'').slice(0,10);
  $('#editNote').value = it.note||'';

  if (isDebtRepay){
    $('#editColType').classList.add('hide');
    $('#editColCat').classList.add('hide');
    $('#editColAmount').classList.remove('hide');
    $('#editColDebtRepayFields').classList.remove('hide');
    $('#editAmount').readOnly = true;
    $('#editType').disabled = true; $('#editCat').disabled = true;

    showOverlay(true);
    const debtDetails = await api('debts/tx/get', { tx_id: it.debt_tx_id }, true);
    showOverlay(false);
    const prin = debtDetails.ok ? Number(debtDetails.item?.principal_paid||0) : 0;
    const intr = debtDetails.ok ? Number(debtDetails.item?.interest_paid||0)  : 0;
    $('#editPrin').value = prin ? prin : '';
    $('#editInt').value  = intr ? intr : '';
    $('#editAmount').value = (Math.round((prin+intr)*100)/100).toFixed(2);
    const updateTotal = ()=>{
      const p = Number($('#editPrin').value||0);
      const i = Number($('#editInt').value||0);
      $('#editAmount').value = (Math.round((p+i)*100)/100).toFixed(2);
    };
    $('#editPrin').oninput = updateTotal; $('#editInt').oninput  = updateTotal;
    $('#editBackdrop').dataset.isDebtRepay = 'true';
  }else{
    $('#editColType').classList.remove('hide');
    $('#editColCat').classList.remove('hide');
    $('#editColAmount').classList.remove('hide');
    $('#editColDebtRepayFields').classList.add('hide');
    $('#editType').disabled = false; $('#editCat').disabled = false;
    $('#editAmount').readOnly = false;
    $('#editType').value = it.type;
    populateEditCatSelect();
    $('#editCat').value = it.category_id;
    $('#editAmount').value = String(it.amount||0);
    $('#editBackdrop').dataset.isDebtRepay = 'false';
  }

  $('#editBackdrop').classList.add('show');
  $('#editBackdrop').setAttribute('aria-hidden','false');
}
function closeEdit(){ $('#editBackdrop').classList.remove('show'); $('#editBackdrop').setAttribute('aria-hidden','true'); }
$('#btnCancel').addEventListener('click', closeEdit);
$('#editType').addEventListener('change', populateEditCatSelect);

$('#btnUpdate').addEventListener('click', async ()=>{
  const tx_id = $('#editTxId').value;
  const isDebtRepay = $('#editBackdrop').dataset.isDebtRepay === 'true';
  $('#btnUpdate').disabled = true;

  let r;
  if (isDebtRepay){
    const it = lastItems.find(x=> String(x.tx_id)===String(tx_id));
    const debt_tx_id = it ? it.debt_tx_id : '';
    if (!debt_tx_id){ toast('ไม่พบรหัสธุรกรรมหนี้', false); $('#btnUpdate').disabled=false; return; }
    const principal_paid = Number($('#editPrin').value||0);
    const interest_paid  = Number($('#editInt').value||0);
    const payload = {
      debt_tx_id,
      date: $('#editDate').value,
      note: $('#editNote').value.trim(),
      principal_paid: Math.round(principal_paid*100)/100,
      interest_paid:  Math.round(interest_paid*100)/100
    };
    r = await api('debts/tx/update', payload, true, true);
  }else{
    const amount = Number($('#editAmount').value);
    const payload = {
      tx_id,
      date: $('#editDate').value,
      type: $('#editType').value,
      category_id: $('#editCat').value,
      amount: Math.round(amount*100)/100,
      note: $('#editNote').value.trim()
    };
    if (!(payload.date && payload.category_id && isFinite(payload.amount) && payload.amount>0)){
      toast('ข้อมูลไม่ครบหรือจำนวนเงินไม่ถูกต้อง', false); $('#btnUpdate').disabled=false; return;
    }
    r = await api('transactions/update', payload, true, true);
  }

  $('#btnUpdate').disabled = false;
  if (r.ok){ toast('บันทึกแก้ไขสำเร็จ'); closeEdit(); loadDebtsBoth(); refreshList(); }
  else toast(r.message||'อัปเดตไม่สำเร็จ', false);
});

async function confirmDelete(tx_id){
  if (!tx_id) return;
  if (!confirm('ยืนยันการลบรายการนี้?')) return;
  showOverlay(true);
  const r = await api('transactions/delete', { tx_id }, true);
  showOverlay(false);
  if (r.ok){ toast('ลบสำเร็จ'); loadDebtsBoth(); refreshList(); }
  else toast(r.message||'ลบไม่สำเร็จ', false);
}

/** ====== Add/Edit/Close Debt ====== */
$('#btnAddDebt').addEventListener('click', async ()=>{
  const lender_name = $('#dName').value.trim();
  const annual_rate = Number($('#dRate').value||0);
  const principal_initial = Number($('#dPrincipal').value||0);
  if (!lender_name || !isFinite(annual_rate) || annual_rate<0){ toast('กรอกชื่อและอัตราดอกให้ถูกต้อง', false); return; }
  const payload = { lender_name, annual_rate, principal_initial: isFinite(principal_initial)&&principal_initial>0? principal_initial:0, start_date: todayISO() };
  const r = await api('debts/create', payload, true, true);
  if (r.ok){ toast('เพิ่มเจ้าหนี้สำเร็จ'); $('#dName').value=''; $('#dRate').value=''; $('#dPrincipal').value=''; loadDebtsBoth(); }
  else toast(r.message||'ไม่สำเร็จ', false);
});
$('#btnAddDebtOpen').addEventListener('click', ()=>{ document.querySelector('#debtAddRow')?.scrollIntoView({behavior:'smooth', block:'center'}); });

$('#tblDebts').addEventListener('click', async (e)=>{
  const btn = e.target.closest('button[data-dact]');
  if (!btn) return;
  const id = btn.getAttribute('data-id');
  const act = btn.getAttribute('data-dact');
  if (act==='edit'){ openDebtEdit(id); return; }
  if (act==='close'){
    if (!confirm('ยืนยันการปิดบัญชีหนี้นี้หรือไม่?')) return;
    const r = await api('debts/close', { debt_id:id }, true, true);
    if (r.ok){ toast('ปิดบัญชีสำเร็จ'); loadDebtsBoth(); }
    else toast(r.message||'ปิดบัญชีไม่สำเร็จ', false);
  }
});
function openDebtEdit(id){
  const d = debtsCache.find(x=> String(x.debt_id)===String(id));
  if (!d){ toast('ไม่พบเจ้าหนี้', false); return; }
  $('#editDebtId').value = d.debt_id;
  $('#editDebtName').value = d.lender_name || '';
  $('#editDebtRate').value = (d.annual_rate ?? 0);
  $('#editDebtBackdrop').classList.add('show');
  $('#editDebtBackdrop').setAttribute('aria-hidden','false');
}
function closeDebtEdit(){
  $('#editDebtBackdrop').classList.remove('show');
  $('#editDebtBackdrop').setAttribute('aria-hidden','true');
}
$('#btnEditDebtCancel').addEventListener('click', closeDebtEdit);
$('#btnEditDebtSave').addEventListener('click', async ()=>{
  const id = $('#editDebtId').value;
  const name = $('#editDebtName').value.trim();
  const rate = Number($('#editDebtRate').value);
  if (!id){ toast('ไม่พบรหัสเจ้าหนี้', false); return; }
  if (!name){ toast('กรุณากรอกชื่อเจ้าหนี้', false); return; }
  if (!isFinite(rate) || rate<0){ toast('อัตราดอกไม่ถูกต้อง', false); return; }
  const r = await api('debts/update', { debt_id:id, lender_name:name, annual_rate:Math.round(rate*100)/100 }, true, true);
  if (r.ok){ toast('บันทึกแก้ไขสำเร็จ'); closeDebtEdit(); loadDebtsBoth(); }
  else toast(r.message||'อัปเดตไม่สำเร็จ', false);
});

/** ====== Range Shortcuts (debounce กันยิง API ถี่) ====== */
const debouncedRefresh = debounce(()=> refreshList(), 350);
function setRange(from, to){ $('#fFrom').value = from; $('#fTo').value = to; updateRangeUI(); debouncedRefresh(); }
function setRangeDaysBack(days){
  const now=new Date(); const from=toYMD(new Date(now.getFullYear(), now.getMonth(), now.getDate()-days+1)); const to=toYMD(now);
  setRange(from,to);
}
function ensureRangeDefaults(){
  if (!$('#fFrom').value || !$('#fTo').value){
    const mb = monthBounds(new Date()); setRange(mb.start, mb.end);
  }else updateRangeUI();
}
function updateRangeUI(){
  const f=$('#fFrom').value, t=$('#fTo').value;
  const today=todayISO(); const mb=monthBounds(new Date()); const y=new Date().getFullYear();
  const flags={
    today:(f===today && t===today),
    d7:(f===toYMD(new Date(new Date().setDate(new Date().getDate()-6))) && t===today),
    d30:(f===toYMD(new Date(new Date().setDate(new Date().getDate()-29))) && t===today),
    month:(f===mb.start && t===mb.end),
    year:(f===`${y}-01-01` && t===`${y}-12-31`)
  };
  document.querySelectorAll('.chip[data-range]').forEach(ch=>{
    const k=ch.dataset.range;
    const on=(k==='today'&&flags.today)||(k==='7'&&flags.d7)||(k==='30'&&flags.d30)||(k==='month'&&flags.month)||(k==='year'&&flags.year);
    ch.classList.toggle('active',on);
  });
  let txt='กำหนดเอง'; if(flags.today)txt='วันนี้'; else if(flags.d7)txt='7 วันล่าสุด'; else if(flags.d30)txt='30 วันล่าสุด'; else if(flags.month)txt='เดือนนี้'; else if(flags.year)txt='ปีนี้';
  $('#rangeBadge').textContent=txt;
}
document.querySelectorAll('.chip[data-range]').forEach(ch=>{
  ch.addEventListener('click', ()=>{
    const k=ch.dataset.range;
    if (k==='today'){ const d=todayISO(); setRange(d,d); }
    if (k==='7') setRangeDaysBack(7);
    if (k==='30') setRangeDaysBack(30);
    if (k==='month'){ const mb=monthBounds(new Date()); setRange(mb.start, mb.end); }
    if (k==='year'){ const y=new Date().getFullYear(); setRange(`${y}-01-01`, `${y}-12-31`); }
  });
});
$('#fFrom').addEventListener('change', ()=>{ updateRangeUI(); debouncedRefresh(); });
$('#fTo').addEventListener('change',   ()=>{ updateRangeUI(); debouncedRefresh(); });
$('#btnRefresh').addEventListener('click', ()=> debouncedRefresh());

/** ====== INIT (บูตร่วมกันแบบขนาน) ====== */
(async function init(){
  $('#txDate').value = todayISO();
  setType('expense');
  const mb = monthBounds(new Date()); $('#fFrom').value = mb.start; $('#fTo').value = mb.end; updateRangeUI();

  // แสดงชื่อที่เคยมีทันที เพื่อให้รู้สึกเร็ว
  if (displayName) $('#who').textContent = displayName;

  showOverlay(true);
  let ok=false;
  try{ ok = await ensureTokenViaLIFF(); }catch(e){ console.error(e); toast('เริ่มต้นผ่าน LIFF ไม่สำเร็จ', false); }
  if (ok){
    // ดึงทุกอย่างพร้อมกัน
    const from = $('#fFrom').value, to = $('#fTo').value;
    const [_, __, rTx] = await Promise.all([
      loadCategoriesAll(),
      loadDebtsBoth(),
      api('transactions/list', { from, to, type:'all' }, true),
    ]);
    if (rTx.ok){ lastItems = (rTx.items||[]).map(x=> ({...x, amount:+x.amount})); renderTable(lastItems); }
    populateCatSelect();
  }
  showOverlay(false);
})();

/** ====== UI Listeners ====== */
$$('.segbtn').forEach(b=> b.addEventListener('click', ()=> setType(b.dataset.type)));
$('#btnCancel').addEventListener('click', closeEdit);
  </script>
</body>
</html>
